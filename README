Гарантированно такой функционал реализуется только в одном случае: если мы можем внести все сделанные 
изменения в ресурс атомарно.
Если изменяемых ресурсов больше одного, или хотя бы один из них не допускает атомарного внесения
всех изменений, то об атомарности кода в целом можно говорить очень условно.

